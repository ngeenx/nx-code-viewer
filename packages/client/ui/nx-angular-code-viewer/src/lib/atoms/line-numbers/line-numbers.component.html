<div class="line-numbers-container" [class]="theme()" aria-hidden="true">
  @for (
    lineNumber of lineNumbers();
    track trackByLineNumber($index, lineNumber)
  ) {
    @let collapseInfo = getLineCollapseInfo(lineNumber);

    @if (isLineVisible(lineNumber)) {
      <!-- Regular line number or first line of collapsed range -->
      <div
        class="line-number"
        [class.highlighted]="isHighlighted(lineNumber)"
        [class.collapsed-first]="collapseInfo.isFirstLine"
        (mouseenter)="onMouseEnter(lineNumber)">
        {{ formatLine(lineNumber) }}
      </div>

      <!-- Show collapse indicator row after first line of collapsed range -->
      @if (collapseInfo.isFirstLine && collapseInfo.range) {
        <div
          class="line-number collapse-indicator"
          role="button"
          tabindex="0"
          [attr.aria-label]="
            'Expand ' +
            collapseInfo.hiddenCount +
            ' hidden ' +
            (collapseInfo.hiddenCount === 1 ? 'line' : 'lines')
          "
          (click)="onExpandToggle(collapseInfo.range)"
          (keydown.enter)="onExpandToggle(collapseInfo.range)"
          (keydown.space)="onExpandToggle(collapseInfo.range); $event.preventDefault()">
          <svg
            viewBox="0 0 24 24"
            width="18"
            height="18"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round">
            <path d="m7 15 5 5 5-5" />
            <path d="m7 9 5-5 5 5" />
          </svg>
        </div>
      }

      <!-- Empty placeholder for insert widget (syncs line numbers with code rows) -->
      @if (hasInsertWidgetAfter(lineNumber)) {
        <div
          class="insert-widget-placeholder"
          [style.height.px]="insertWidgetHeight()">
        </div>
      }
    }
  }
</div>
